var Gt=Object.defineProperty;var nt=e=>{throw TypeError(e)};var Wt=(e,t,r)=>t in e?Gt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var d=(e,t,r)=>Wt(e,typeof t!="symbol"?t+"":t,r),Me=(e,t,r)=>t.has(e)||nt("Cannot "+r);var i=(e,t,r)=>(Me(e,t,"read from private field"),r?r.call(e):t.get(e)),p=(e,t,r)=>t.has(e)?nt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),u=(e,t,r,s)=>(Me(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r),b=(e,t,r)=>(Me(e,t,"access private method"),r);var it=(e,t,r,s)=>({set _(n){u(e,t,n,r)},get _(){return i(e,t,s)}});import"fs";import{createServer as Vt}from"http";import{Http2ServerRequest as ot}from"http2";import{Readable as zt}from"stream";import Xt from"crypto";var Yt=async(e,t=Object.create(null))=>{const{all:r=!1,dot:s=!1}=t,o=(e instanceof Pt?e.raw.headers:e.headers).get("Content-Type");return o!=null&&o.startsWith("multipart/form-data")||o!=null&&o.startsWith("application/x-www-form-urlencoded")?Qt(e,{all:r,dot:s}):{}};async function Qt(e,t){const r=await e.formData();return r?Jt(r,t):{}}function Jt(e,t){const r=Object.create(null);return e.forEach((s,n)=>{t.all||n.endsWith("[]")?Zt(r,n,s):r[n]=s}),t.dot&&Object.entries(r).forEach(([s,n])=>{s.includes(".")&&(er(r,s,n),delete r[s])}),r}var Zt=(e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:e[t]=r},er=(e,t,r)=>{let s=e;const n=t.split(".");n.forEach((o,a)=>{a===n.length-1?s[o]=r:((!s[o]||typeof s[o]!="object"||Array.isArray(s[o])||s[o]instanceof File)&&(s[o]=Object.create(null)),s=s[o])})},Rt=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},tr=e=>{const{groups:t,path:r}=rr(e),s=Rt(r);return sr(s,t)},rr=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(r,s)=>{const n=`@${s}`;return t.push([n,r]),n}),{groups:t,path:e}},sr=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[s]=t[r];for(let n=e.length-1;n>=0;n--)if(e[n].includes(s)){e[n]=e[n].replace(s,t[r][1]);break}}return e},Ce={},at=e=>{if(e==="*")return"*";const t=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);return t?(Ce[e]||(t[2]?Ce[e]=[e,t[1],new RegExp("^"+t[2]+"$")]:Ce[e]=[e,t[1],!0]),Ce[e]):null},vt=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},nr=e=>vt(e,decodeURI),Et=e=>{const t=e.url,r=t.indexOf("/",8);let s=r;for(;s<t.length;s++){const n=t.charCodeAt(s);if(n===37){const o=t.indexOf("?",s),a=t.slice(r,o===-1?void 0:o);return nr(a.includes("%25")?a.replace(/%25/g,"%2525"):a)}else if(n===63)break}return t.slice(r,s)},ir=e=>{const t=Et(e);return t.length>1&&t[t.length-1]==="/"?t.slice(0,-1):t},de=(...e)=>{let t="",r=!1;for(let s of e)t[t.length-1]==="/"&&(t=t.slice(0,-1),r=!0),s[0]!=="/"&&(s=`/${s}`),s==="/"&&r?t=`${t}/`:s!=="/"&&(t=`${t}${s}`),s==="/"&&t===""&&(t="/");return t},xt=e=>{if(!e.match(/\:.+\?$/))return null;const t=e.split("/"),r=[];let s="";return t.forEach(n=>{if(n!==""&&!/\:/.test(n))s+="/"+n;else if(/\:/.test(n))if(/\?/.test(n)){r.length===0&&s===""?r.push("/"):r.push(s);const o=n.replace("?","");s+="/"+o,r.push(s)}else s+="/"+n}),r.filter((n,o,a)=>a.indexOf(n)===o)},Ue=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?jt(e):e):e,Ot=(e,t,r)=>{let s;if(!r&&t&&!/[%+]/.test(t)){let a=e.indexOf(`?${t}`,8);for(a===-1&&(a=e.indexOf(`&${t}`,8));a!==-1;){const h=e.charCodeAt(a+t.length+1);if(h===61){const c=a+t.length+2,l=e.indexOf("&",c);return Ue(e.slice(c,l===-1?void 0:l))}else if(h==38||isNaN(h))return"";a=e.indexOf(`&${t}`,a+1)}if(s=/[%+]/.test(e),!s)return}const n={};s??(s=/[%+]/.test(e));let o=e.indexOf("?",8);for(;o!==-1;){const a=e.indexOf("&",o+1);let h=e.indexOf("=",o);h>a&&a!==-1&&(h=-1);let c=e.slice(o+1,h===-1?a===-1?void 0:a:h);if(s&&(c=Ue(c)),o=a,c==="")continue;let l;h===-1?l="":(l=e.slice(h+1,a===-1?void 0:a),s&&(l=Ue(l))),r?(n[c]&&Array.isArray(n[c])||(n[c]=[]),n[c].push(l)):n[c]??(n[c]=l)}return t?n[t]:n},or=Ot,ar=(e,t)=>Ot(e,t,!0),jt=decodeURIComponent,ct=e=>vt(e,jt),ie,C,U,St,Ht,We,B,ft,Pt=(ft=class{constructor(e,t="/",r=[[]]){p(this,U);d(this,"raw");p(this,ie);p(this,C);d(this,"routeIndex",0);d(this,"path");d(this,"bodyCache",{});p(this,B,e=>{const{bodyCache:t,raw:r}=this,s=t[e];if(s)return s;const n=Object.keys(t)[0];return n?t[n].then(o=>(n==="json"&&(o=JSON.stringify(o)),new Response(o)[e]())):t[e]=r[e]()});this.raw=e,this.path=t,u(this,C,r),u(this,ie,{})}param(e){return e?b(this,U,St).call(this,e):b(this,U,Ht).call(this)}query(e){return or(this.url,e)}queries(e){return ar(this.url,e)}header(e){if(e)return this.raw.headers.get(e.toLowerCase())??void 0;const t={};return this.raw.headers.forEach((r,s)=>{t[s]=r}),t}async parseBody(e){var t;return(t=this.bodyCache).parsedBody??(t.parsedBody=await Yt(this,e))}json(){return i(this,B).call(this,"json")}text(){return i(this,B).call(this,"text")}arrayBuffer(){return i(this,B).call(this,"arrayBuffer")}blob(){return i(this,B).call(this,"blob")}formData(){return i(this,B).call(this,"formData")}addValidatedData(e,t){i(this,ie)[e]=t}valid(e){return i(this,ie)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return i(this,C)[0].map(([[,e]])=>e)}get routePath(){return i(this,C)[0].map(([[,e]])=>e)[this.routeIndex].path}},ie=new WeakMap,C=new WeakMap,U=new WeakSet,St=function(e){const t=i(this,C)[0][this.routeIndex][1][e],r=b(this,U,We).call(this,t);return r?/\%/.test(r)?ct(r):r:void 0},Ht=function(){const e={},t=Object.keys(i(this,C)[0][this.routeIndex][1]);for(const r of t){const s=b(this,U,We).call(this,i(this,C)[0][this.routeIndex][1][r]);s&&typeof s=="string"&&(e[r]=/\%/.test(s)?ct(s):s)}return e},We=function(e){return i(this,C)[1]?i(this,C)[1][e]:e},B=new WeakMap,ft),cr={Stringify:1},At=async(e,t,r,s,n)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));const o=e.callbacks;return o!=null&&o.length?(n?n[0]+=e:n=[e],Promise.all(o.map(h=>h({phase:t,buffer:n,context:s}))).then(h=>Promise.all(h.filter(Boolean).map(c=>At(c,t,!1,s,n))).then(()=>n[0]))):Promise.resolve(e)},hr="text/plain; charset=UTF-8",Be=(e,t={})=>{for(const r of Object.keys(t))e.set(r,t[r]);return e},ve,Ee,D,Q,F,m,R,q,k,xe,oe,ae,Oe,je,j,S,ut,Ct=(ut=class{constructor(e,t){p(this,j);p(this,ve);p(this,Ee);d(this,"env",{});p(this,D);d(this,"finalized",!1);d(this,"error");p(this,Q,200);p(this,F);p(this,m);p(this,R);p(this,q);p(this,k,!0);p(this,xe);p(this,oe);p(this,ae);p(this,Oe);p(this,je);d(this,"render",(...e)=>(i(this,oe)??u(this,oe,t=>this.html(t)),i(this,oe).call(this,...e)));d(this,"setLayout",e=>u(this,xe,e));d(this,"getLayout",()=>i(this,xe));d(this,"setRenderer",e=>{u(this,oe,e)});d(this,"header",(e,t,r)=>{if(t===void 0){i(this,m)?i(this,m).delete(e):i(this,R)&&delete i(this,R)[e.toLocaleLowerCase()],this.finalized&&this.res.headers.delete(e);return}r!=null&&r.append?(i(this,m)||(u(this,k,!1),u(this,m,new Headers(i(this,R))),u(this,R,{})),i(this,m).append(e,t)):i(this,m)?i(this,m).set(e,t):(i(this,R)??u(this,R,{}),i(this,R)[e.toLowerCase()]=t),this.finalized&&(r!=null&&r.append?this.res.headers.append(e,t):this.res.headers.set(e,t))});d(this,"status",e=>{u(this,k,!1),u(this,Q,e)});d(this,"set",(e,t)=>{i(this,D)??u(this,D,new Map),i(this,D).set(e,t)});d(this,"get",e=>i(this,D)?i(this,D).get(e):void 0);d(this,"newResponse",(...e)=>b(this,j,S).call(this,...e));d(this,"body",(e,t,r)=>typeof t=="number"?b(this,j,S).call(this,e,t,r):b(this,j,S).call(this,e,t));d(this,"text",(e,t,r)=>{if(!i(this,R)){if(i(this,k)&&!r&&!t)return new Response(e);u(this,R,{})}return i(this,R)["content-type"]=hr,typeof t=="number"?b(this,j,S).call(this,e,t,r):b(this,j,S).call(this,e,t)});d(this,"json",(e,t,r)=>{const s=JSON.stringify(e);return i(this,R)??u(this,R,{}),i(this,R)["content-type"]="application/json; charset=UTF-8",typeof t=="number"?b(this,j,S).call(this,s,t,r):b(this,j,S).call(this,s,t)});d(this,"html",(e,t,r)=>(i(this,R)??u(this,R,{}),i(this,R)["content-type"]="text/html; charset=UTF-8",typeof e=="object"?At(e,cr.Stringify,!1,{}).then(s=>typeof t=="number"?b(this,j,S).call(this,s,t,r):b(this,j,S).call(this,s,t)):typeof t=="number"?b(this,j,S).call(this,e,t,r):b(this,j,S).call(this,e,t)));d(this,"redirect",(e,t)=>(i(this,m)??u(this,m,new Headers),i(this,m).set("Location",String(e)),this.newResponse(null,t??302)));d(this,"notFound",()=>(i(this,ae)??u(this,ae,()=>new Response),i(this,ae).call(this,this)));u(this,ve,e),t&&(u(this,F,t.executionCtx),this.env=t.env,u(this,ae,t.notFoundHandler),u(this,je,t.path),u(this,Oe,t.matchResult))}get req(){return i(this,Ee)??u(this,Ee,new Pt(i(this,ve),i(this,je),i(this,Oe))),i(this,Ee)}get event(){if(i(this,F)&&"respondWith"in i(this,F))return i(this,F);throw Error("This context has no FetchEvent")}get executionCtx(){if(i(this,F))return i(this,F);throw Error("This context has no ExecutionContext")}get res(){return u(this,k,!1),i(this,q)||u(this,q,new Response("404 Not Found",{status:404}))}set res(e){if(u(this,k,!1),i(this,q)&&e)try{for(const[t,r]of i(this,q).headers.entries())if(t!=="content-type")if(t==="set-cookie"){const s=i(this,q).headers.getSetCookie();e.headers.delete("set-cookie");for(const n of s)e.headers.append("set-cookie",n)}else e.headers.set(t,r)}catch(t){if(t instanceof TypeError&&t.message.includes("immutable")){this.res=new Response(e.body,{headers:e.headers,status:e.status});return}else throw t}u(this,q,e),this.finalized=!0}get var(){return i(this,D)?Object.fromEntries(i(this,D)):{}}},ve=new WeakMap,Ee=new WeakMap,D=new WeakMap,Q=new WeakMap,F=new WeakMap,m=new WeakMap,R=new WeakMap,q=new WeakMap,k=new WeakMap,xe=new WeakMap,oe=new WeakMap,ae=new WeakMap,Oe=new WeakMap,je=new WeakMap,j=new WeakSet,S=function(e,t,r){if(i(this,k)&&!r&&!t&&i(this,Q)===200)return new Response(e,{headers:i(this,R)});if(t&&typeof t!="number"){const n=new Headers(t.headers);i(this,m)&&i(this,m).forEach((a,h)=>{h==="set-cookie"?n.append(h,a):n.set(h,a)});const o=Be(n,i(this,R));return new Response(e,{headers:o,status:t.status??i(this,Q)})}const s=typeof t=="number"?t:i(this,Q);i(this,R)??u(this,R,{}),i(this,m)??u(this,m,new Headers),Be(i(this,m),i(this,R)),i(this,q)&&(i(this,q).headers.forEach((n,o)=>{var a,h;o==="set-cookie"?(a=i(this,m))==null||a.append(o,n):(h=i(this,m))==null||h.set(o,n)}),Be(i(this,m),i(this,R))),r??(r={});for(const[n,o]of Object.entries(r))if(typeof o=="string")i(this,m).set(n,o);else{i(this,m).delete(n);for(const a of o)i(this,m).append(n,a)}return new Response(e,{status:s,headers:i(this,m)})},ut),ht=(e,t,r)=>(s,n)=>{let o=-1;const a=s instanceof Ct;return h(0);async function h(c){if(c<=o)throw new Error("next() called multiple times");o=c;let l,f=!1,y;if(e[c]?(y=e[c][0][0],a&&(s.req.routeIndex=c)):y=c===e.length&&n||void 0,!y)a&&s.finalized===!1&&r&&(l=await r(s));else try{l=await y(s,()=>h(c+1))}catch(g){if(g instanceof Error&&a&&t)s.error=g,l=await t(g,s),f=!0;else throw g}return l&&(s.finalized===!1||f)&&(s.res=l),s}},v="ALL",lr="all",fr=["get","post","put","delete","options","patch"],$t="Can not add a route since the matcher is already built.",Tt=class extends Error{},ur=Symbol("composedHandler"),dr=e=>e.text("404 Not Found",404),lt=(e,t)=>"getResponse"in e?e.getResponse():(console.error(e),t.text("Internal Server Error",500)),$,E,qt,_,X,Te,Le,dt,Lt=(dt=class{constructor(t={}){p(this,E);d(this,"get");d(this,"post");d(this,"put");d(this,"delete");d(this,"options");d(this,"patch");d(this,"all");d(this,"on");d(this,"use");d(this,"router");d(this,"getPath");d(this,"_basePath","/");p(this,$,"/");d(this,"routes",[]);p(this,_,dr);d(this,"errorHandler",lt);d(this,"onError",t=>(this.errorHandler=t,this));d(this,"notFound",t=>(u(this,_,t),this));d(this,"fetch",(t,...r)=>b(this,E,Le).call(this,t,r[1],r[0],t.method));d(this,"request",(t,r,s,n)=>t instanceof Request?this.fetch(r?new Request(t,r):t,s,n):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${de("/",t)}`,r),s,n)));d(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(b(this,E,Le).call(this,t.request,t,void 0,t.request.method))})});[...fr,lr].forEach(n=>{this[n]=(o,...a)=>(typeof o=="string"?u(this,$,o):b(this,E,X).call(this,n,i(this,$),o),a.forEach(h=>{b(this,E,X).call(this,n,i(this,$),h)}),this)}),this.on=(n,o,...a)=>{for(const h of[o].flat()){u(this,$,h);for(const c of[n].flat())a.map(l=>{b(this,E,X).call(this,c.toUpperCase(),i(this,$),l)})}return this},this.use=(n,...o)=>(typeof n=="string"?u(this,$,n):(u(this,$,"*"),o.unshift(n)),o.forEach(a=>{b(this,E,X).call(this,v,i(this,$),a)}),this);const s=t.strict??!0;delete t.strict,Object.assign(this,t),this.getPath=s?t.getPath??Et:ir}route(t,r){const s=this.basePath(t);return r.routes.map(n=>{var a;let o;r.errorHandler===lt?o=n.handler:(o=async(h,c)=>(await ht([],r.errorHandler)(h,()=>n.handler(h,c))).res,o[ur]=n.handler),b(a=s,E,X).call(a,n.method,n.path,o)}),this}basePath(t){const r=b(this,E,qt).call(this);return r._basePath=de(this._basePath,t),r}mount(t,r,s){let n,o;s&&(typeof s=="function"?o=s:(o=s.optionHandler,n=s.replaceRequest));const a=o?c=>{const l=o(c);return Array.isArray(l)?l:[l]}:c=>{let l;try{l=c.executionCtx}catch{}return[c.env,l]};n||(n=(()=>{const c=de(this._basePath,t),l=c==="/"?0:c.length;return f=>{const y=new URL(f.url);return y.pathname=y.pathname.slice(l)||"/",new Request(y,f)}})());const h=async(c,l)=>{const f=await r(n(c.req.raw),...a(c));if(f)return f;await l()};return b(this,E,X).call(this,v,de(t,"*"),h),this}},$=new WeakMap,E=new WeakSet,qt=function(){const t=new Lt({router:this.router,getPath:this.getPath});return t.routes=this.routes,t},_=new WeakMap,X=function(t,r,s){t=t.toUpperCase(),r=de(this._basePath,r);const n={path:r,method:t,handler:s};this.router.add(t,r,[s,n]),this.routes.push(n)},Te=function(t,r){if(t instanceof Error)return this.errorHandler(t,r);throw t},Le=function(t,r,s,n){if(n==="HEAD")return(async()=>new Response(null,await b(this,E,Le).call(this,t,r,s,"GET")))();const o=this.getPath(t,{env:s}),a=this.router.match(n,o),h=new Ct(t,{path:o,matchResult:a,env:s,executionCtx:r,notFoundHandler:i(this,_)});if(a[0].length===1){let l;try{l=a[0][0][0][0](h,async()=>{h.res=await i(this,_).call(this,h)})}catch(f){return b(this,E,Te).call(this,f,h)}return l instanceof Promise?l.then(f=>f||(h.finalized?h.res:i(this,_).call(this,h))).catch(f=>b(this,E,Te).call(this,f,h)):l??i(this,_).call(this,h)}const c=ht(a[0],this.errorHandler,i(this,_));return(async()=>{try{const l=await c(h);if(!l.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return l.res}catch(l){return b(this,E,Te).call(this,l,h)}})()},dt),Ie="[^/]+",be=".*",ge="(?:|/.*)",ye=Symbol(),pr=new Set(".\\+*[^]$()");function yr(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===be||e===ge?1:t===be||t===ge?-1:e===Ie?1:t===Ie?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var J,Z,T,pt,Ve=(pt=class{constructor(){p(this,J);p(this,Z);p(this,T,Object.create(null))}insert(t,r,s,n,o){if(t.length===0){if(i(this,J)!==void 0)throw ye;if(o)return;u(this,J,r);return}const[a,...h]=t,c=a==="*"?h.length===0?["","",be]:["","",Ie]:a==="/*"?["","",ge]:a.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let l;if(c){const f=c[1];let y=c[2]||Ie;if(f&&c[2]&&(y=y.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(y)))throw ye;if(l=i(this,T)[y],!l){if(Object.keys(i(this,T)).some(g=>g!==be&&g!==ge))throw ye;if(o)return;l=i(this,T)[y]=new Ve,f!==""&&u(l,Z,n.varIndex++)}!o&&f!==""&&s.push([f,i(l,Z)])}else if(l=i(this,T)[a],!l){if(Object.keys(i(this,T)).some(f=>f.length>1&&f!==be&&f!==ge))throw ye;if(o)return;l=i(this,T)[a]=new Ve}l.insert(h,r,s,n,o)}buildRegExpStr(){const r=Object.keys(i(this,T)).sort(yr).map(s=>{const n=i(this,T)[s];return(typeof i(n,Z)=="number"?`(${s})@${i(n,Z)}`:pr.has(s)?`\\${s}`:s)+n.buildRegExpStr()});return typeof i(this,J)=="number"&&r.unshift(`#${i(this,J)}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}},J=new WeakMap,Z=new WeakMap,T=new WeakMap,pt),Fe,Pe,yt,br=(yt=class{constructor(){p(this,Fe,{varIndex:0});p(this,Pe,new Ve)}insert(e,t,r){const s=[],n=[];for(let a=0;;){let h=!1;if(e=e.replace(/\{[^}]+\}/g,c=>{const l=`@\\${a}`;return n[a]=[l,c],a++,h=!0,l}),!h)break}const o=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let a=n.length-1;a>=0;a--){const[h]=n[a];for(let c=o.length-1;c>=0;c--)if(o[c].indexOf(h)!==-1){o[c]=o[c].replace(h,n[a][1]);break}}return i(this,Pe).insert(o,t,s,i(this,Fe),r),s}buildRegExp(){let e=i(this,Pe).buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const r=[],s=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(n,o,a)=>o!==void 0?(r[++t]=Number(o),"$()"):(a!==void 0&&(s[Number(a)]=++t),"")),[new RegExp(`^${e}`),r,s]}},Fe=new WeakMap,Pe=new WeakMap,yt),It=[],gr=[/^$/,[],Object.create(null)],qe=Object.create(null);function Dt(e){return qe[e]??(qe[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`))}function wr(){qe=Object.create(null)}function mr(e){var l;const t=new br,r=[];if(e.length===0)return gr;const s=e.map(f=>[!/\*|\/:/.test(f[0]),...f]).sort(([f,y],[g,w])=>f?1:g?-1:y.length-w.length),n=Object.create(null);for(let f=0,y=-1,g=s.length;f<g;f++){const[w,x,L]=s[f];w?n[x]=[L.map(([H])=>[H,Object.create(null)]),It]:y++;let I;try{I=t.insert(x,y,w)}catch(H){throw H===ye?new Tt(x):H}w||(r[y]=L.map(([H,A])=>{const He=Object.create(null);for(A-=1;A>=0;A--){const[Ae,re]=I[A];He[Ae]=re}return[H,He]}))}const[o,a,h]=t.buildRegExp();for(let f=0,y=r.length;f<y;f++)for(let g=0,w=r[f].length;g<w;g++){const x=(l=r[f][g])==null?void 0:l[1];if(!x)continue;const L=Object.keys(x);for(let I=0,H=L.length;I<H;I++)x[L[I]]=h[x[L[I]]]}const c=[];for(const f in a)c[f]=r[a[f]];return[o,c,n]}function ne(e,t){if(e){for(const r of Object.keys(e).sort((s,n)=>n.length-s.length))if(Dt(r).test(t))return[...e[r]]}}var K,G,fe,Ft,kt,bt,Rr=(bt=class{constructor(){p(this,fe);d(this,"name","RegExpRouter");p(this,K);p(this,G);u(this,K,{[v]:Object.create(null)}),u(this,G,{[v]:Object.create(null)})}add(e,t,r){var h;const s=i(this,K),n=i(this,G);if(!s||!n)throw new Error($t);s[e]||[s,n].forEach(c=>{c[e]=Object.create(null),Object.keys(c[v]).forEach(l=>{c[e][l]=[...c[v][l]]})}),t==="/*"&&(t="*");const o=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const c=Dt(t);e===v?Object.keys(s).forEach(l=>{var f;(f=s[l])[t]||(f[t]=ne(s[l],t)||ne(s[v],t)||[])}):(h=s[e])[t]||(h[t]=ne(s[e],t)||ne(s[v],t)||[]),Object.keys(s).forEach(l=>{(e===v||e===l)&&Object.keys(s[l]).forEach(f=>{c.test(f)&&s[l][f].push([r,o])})}),Object.keys(n).forEach(l=>{(e===v||e===l)&&Object.keys(n[l]).forEach(f=>c.test(f)&&n[l][f].push([r,o]))});return}const a=xt(t)||[t];for(let c=0,l=a.length;c<l;c++){const f=a[c];Object.keys(n).forEach(y=>{var g;(e===v||e===y)&&((g=n[y])[f]||(g[f]=[...ne(s[y],f)||ne(s[v],f)||[]]),n[y][f].push([r,o-l+c+1]))})}}match(e,t){wr();const r=b(this,fe,Ft).call(this);return this.match=(s,n)=>{const o=r[s]||r[v],a=o[2][n];if(a)return a;const h=n.match(o[0]);if(!h)return[[],It];const c=h.indexOf("",1);return[o[1][c],h]},this.match(e,t)}},K=new WeakMap,G=new WeakMap,fe=new WeakSet,Ft=function(){const e=Object.create(null);return Object.keys(i(this,G)).concat(Object.keys(i(this,K))).forEach(t=>{e[t]||(e[t]=b(this,fe,kt).call(this,t))}),u(this,K,u(this,G,void 0)),e},kt=function(e){const t=[];let r=e===v;return[i(this,K),i(this,G)].forEach(s=>{const n=s[e]?Object.keys(s[e]).map(o=>[o,s[e][o]]):[];n.length!==0?(r||(r=!0),t.push(...n)):e!==v&&t.push(...Object.keys(s[v]).map(o=>[o,s[v][o]]))}),r?mr(t):null},bt),W,N,gt,vr=(gt=class{constructor(e){d(this,"name","SmartRouter");p(this,W,[]);p(this,N,[]);u(this,W,e.routers)}add(e,t,r){if(!i(this,N))throw new Error($t);i(this,N).push([e,t,r])}match(e,t){if(!i(this,N))throw new Error("Fatal error");const r=i(this,W),s=i(this,N),n=r.length;let o=0,a;for(;o<n;o++){const h=r[o];try{for(let c=0,l=s.length;c<l;c++)h.add(...s[c]);a=h.match(e,t)}catch(c){if(c instanceof Tt)continue;throw c}this.match=h.match.bind(h),u(this,W,[h]),u(this,N,void 0);break}if(o===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,a}get activeRouter(){if(i(this,N)||i(this,W).length!==1)throw new Error("No active router has been determined yet.");return i(this,W)[0]}},W=new WeakMap,N=new WeakMap,gt),V,O,ee,ce,P,M,Y,wt,_t=(wt=class{constructor(e,t,r){p(this,M);p(this,V);p(this,O);p(this,ee);p(this,ce,0);p(this,P,Object.create(null));if(u(this,O,r||Object.create(null)),u(this,V,[]),e&&t){const s=Object.create(null);s[e]={handler:t,possibleKeys:[],score:0},u(this,V,[s])}u(this,ee,[])}insert(e,t,r){u(this,ce,++it(this,ce)._);let s=this;const n=tr(t),o=[];for(let c=0,l=n.length;c<l;c++){const f=n[c];if(Object.keys(i(s,O)).includes(f)){s=i(s,O)[f];const g=at(f);g&&o.push(g[1]);continue}i(s,O)[f]=new _t;const y=at(f);y&&(i(s,ee).push(y),o.push(y[1])),s=i(s,O)[f]}const a=Object.create(null),h={handler:r,possibleKeys:o.filter((c,l,f)=>f.indexOf(c)===l),score:i(this,ce)};return a[e]=h,i(s,V).push(a),s}search(e,t){const r=[];u(this,P,Object.create(null));let n=[this];const o=Rt(t);for(let a=0,h=o.length;a<h;a++){const c=o[a],l=a===h-1,f=[];for(let y=0,g=n.length;y<g;y++){const w=n[y],x=i(w,O)[c];x&&(u(x,P,i(w,P)),l?(i(x,O)["*"]&&r.push(...b(this,M,Y).call(this,i(x,O)["*"],e,i(w,P),Object.create(null))),r.push(...b(this,M,Y).call(this,x,e,i(w,P),Object.create(null)))):f.push(x));for(let L=0,I=i(w,ee).length;L<I;L++){const H=i(w,ee)[L],A={...i(w,P)};if(H==="*"){const Ne=i(w,O)["*"];Ne&&(r.push(...b(this,M,Y).call(this,Ne,e,i(w,P),Object.create(null))),f.push(Ne));continue}if(c==="")continue;const[He,Ae,re]=H,se=i(w,O)[He],st=o.slice(a).join("/");if(re instanceof RegExp&&re.test(st)){A[Ae]=st,r.push(...b(this,M,Y).call(this,se,e,i(w,P),A));continue}(re===!0||re.test(c))&&(A[Ae]=c,l?(r.push(...b(this,M,Y).call(this,se,e,A,i(w,P))),i(se,O)["*"]&&r.push(...b(this,M,Y).call(this,i(se,O)["*"],e,A,i(w,P)))):(u(se,P,A),f.push(se)))}}n=f}return r.length>1&&r.sort((a,h)=>a.score-h.score),[r.map(({handler:a,params:h})=>[a,h])]}},V=new WeakMap,O=new WeakMap,ee=new WeakMap,ce=new WeakMap,P=new WeakMap,M=new WeakSet,Y=function(e,t,r,s){const n=[];for(let o=0,a=i(e,V).length;o<a;o++){const h=i(e,V)[o],c=h[t]||h[v],l={};if(c!==void 0){c.params=Object.create(null);for(let f=0,y=c.possibleKeys.length;f<y;f++){const g=c.possibleKeys[f],w=l[c.score];c.params[g]=s[g]&&!w?s[g]:r[g]??s[g],l[c.score]=!0}n.push(c)}}return n},wt),te,mt,Er=(mt=class{constructor(){d(this,"name","TrieRouter");p(this,te);u(this,te,new _t)}add(e,t,r){const s=xt(t);if(s){for(let n=0,o=s.length;n<o;n++)i(this,te).insert(e,s[n],r);return}i(this,te).insert(e,t,r)}match(e,t){return i(this,te).search(e,t)}},te=new WeakMap,mt),Nt=class extends Lt{constructor(e={}){super(e),this.router=e.router??new vr({routers:[new Rr,new Er]})}};function xr(e=new Date){const t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0");return`${t}-${r}-${s} ${n}:${o}:${a}`}var Or=e=>{const t=e.env.server?e.env.server:e.env,r=t.incoming.socket.remoteAddress,s=t.incoming.socket.remotePort,n=t.incoming.socket.remoteFamily;return{remote:{address:r,port:s,addressType:n==="IPv4"?"IPv4":n==="IPv6"?"IPv6":void 0}}};function ze(e){const t=e.req.header();let r=t["x-forwarded-for"]||t["x-real-ip"]||t["x-client-ip"]||t.forwarded||t["cf-connecting-ip"]||t["true-client-ip"]||t.remoteip||e.req.ip;if(!r)try{r=(Or(e).remote.address||"").replace("::ffff:","")}catch{console.log("无法从连接中获取ip地址,是否是内网环境?")}return r?r.split(",").map(n=>n.trim()).find(n=>!jr(n)):""}function jr(e){const t=e.split(".").map(Number);return t[0]===10||t[0]===172&&t[1]>=16&&t[1]<=31||t[0]===192&&t[1]===168||t[0]===127}function Pr(e){e.all("echo",async(t,r)=>{const s=t.req.header(),n=t.req.query(),o=t.req.method==="GET"?{}:await t.req.json(),a=ze(t);return t.json({header:s,query:n,body:o,ip:a})}),e.get("ip",(t,r)=>{let s=ze(t);return s?t.text(s,200,{"Content-Type":"text/plain"}):t.text("No public IP found")})}const rt=new Nt;Pr(rt);rt.get("/",async e=>e.text(`Hello!  now:${xr(new Date)}
yourIp:${ze(e)}
    `));console.log("启动hono-hk,由插件注入监听...");var Ge,De=(Ge=class extends Error{constructor(e,t){super(e,t)}},d(Ge,"name","RequestError"),Ge),Sr=e=>e instanceof De?e:new De(e.message,{cause:e}),Hr=global.Request,we=class extends Hr{constructor(t,r){var s;typeof t=="object"&&le in t&&(t=t[le]()),typeof((s=r==null?void 0:r.body)==null?void 0:s.getReader)<"u"&&(r.duplex??(r.duplex="half")),super(t,r)}},Ar=(e,t,r,s)=>{const n=[],o=r.rawHeaders;for(let h=0;h<o.length;h+=2){const{[h]:c,[h+1]:l}=o;c.charCodeAt(0)!==58&&n.push([c,l])}const a={method:e,headers:n,signal:s.signal};if(e==="TRACE"){a.method="GET";const h=new we(t,a);return Object.defineProperty(h,"method",{get(){return"TRACE"}}),h}return e==="GET"||e==="HEAD"||(a.body=zt.toWeb(r)),new we(t,a)},le=Symbol("getRequestCache"),Ke=Symbol("requestCache"),Xe=Symbol("incomingKey"),Ye=Symbol("urlKey"),pe=Symbol("abortControllerKey"),Qe=Symbol("getAbortController"),ke={get method(){return this[Xe].method||"GET"},get url(){return this[Ye]},[Qe](){return this[le](),this[pe]},[le](){return this[pe]||(this[pe]=new AbortController),this[Ke]||(this[Ke]=Ar(this.method,this[Ye],this[Xe],this[pe]))}};["body","bodyUsed","cache","credentials","destination","headers","integrity","mode","redirect","referrer","referrerPolicy","signal","keepalive"].forEach(e=>{Object.defineProperty(ke,e,{get(){return this[le]()[e]}})});["arrayBuffer","blob","clone","formData","json","text"].forEach(e=>{Object.defineProperty(ke,e,{value:function(){return this[le]()[e]()}})});Object.setPrototypeOf(ke,we.prototype);var Cr=(e,t)=>{const r=Object.create(ke);r[Xe]=e;const s=(e instanceof ot?e.authority:e.headers.host)||t;if(!s)throw new De("Missing host header");const n=new URL(`${e instanceof ot||e.socket&&e.socket.encrypted?"https":"http"}://${s}${e.url}`);if(n.hostname.length!==s.length&&n.hostname!==s.replace(/:\d+$/,""))throw new De("Invalid host header");return r[Ye]=n.href,r};function Je(e,t){if(e.locked)throw new TypeError("ReadableStream is locked.");if(t.destroyed){e.cancel();return}const r=e.getReader();return t.on("close",s),t.on("error",s),r.read().then(o,s),r.closed.finally(()=>{t.off("close",s),t.off("error",s)});function s(a){r.cancel(a).catch(()=>{}),a&&t.destroy(a)}function n(){r.read().then(o,s)}function o({done:a,value:h}){try{if(a)t.end();else if(!t.write(h))t.once("drain",n);else return r.read().then(o,s)}catch(c){s(c)}}}var Mt=e=>{const t={};e instanceof Headers||(e=new Headers(e??void 0));const r=[];for(const[s,n]of e)s==="set-cookie"?r.push(n):t[s]=n;return r.length>0&&(t["set-cookie"]=r),t["content-type"]??(t["content-type"]="text/plain; charset=UTF-8"),t},$e=Symbol("responseCache"),me=Symbol("getResponseCache"),Re=Symbol("cache"),_e=global.Response,Se,z,he,ue=(he=class{constructor(t,r){p(this,Se);p(this,z);if(u(this,Se,t),r instanceof he){const s=r[$e];if(s){u(this,z,s),this[me]();return}else u(this,z,i(r,z))}else u(this,z,r);if(typeof t=="string"||typeof(t==null?void 0:t.getReader)<"u"){let s=(r==null?void 0:r.headers)||{"content-type":"text/plain; charset=UTF-8"};s instanceof Headers&&(s=Mt(s)),this[Re]=[(r==null?void 0:r.status)||200,t,s]}}[me](){return delete this[Re],this[$e]||(this[$e]=new _e(i(this,Se),i(this,z)))}},Se=new WeakMap,z=new WeakMap,he);["body","bodyUsed","headers","ok","redirected","status","statusText","trailers","type","url"].forEach(e=>{Object.defineProperty(ue.prototype,e,{get(){return this[me]()[e]}})});["arrayBuffer","blob","clone","formData","json","text"].forEach(e=>{Object.defineProperty(ue.prototype,e,{value:function(){return this[me]()[e]()}})});Object.setPrototypeOf(ue,_e);Object.setPrototypeOf(ue.prototype,_e.prototype);var Ze=Reflect.ownKeys(new _e).find(e=>typeof e=="symbol"&&e.toString()==="Symbol(state)");Ze||console.warn("Failed to find Response internal state key");function $r(e){if(!Ze)return;e instanceof ue&&(e=e[me]());const t=e[Ze];return t&&t.body||void 0}var Tr="x-hono-already-sent",Lr=global.fetch;typeof global.crypto>"u"&&(global.crypto=Xt);global.fetch=(e,t)=>(t={compress:!1,...t},Lr(e,t));var qr=/^no$/i,Ir=/^(application\/json\b|text\/(?!event-stream\b))/i,Dr=()=>new Response(null,{status:400}),Ut=e=>new Response(null,{status:e instanceof Error&&(e.name==="TimeoutError"||e.constructor.name==="TimeoutError")?504:500}),et=(e,t)=>{const r=e instanceof Error?e:new Error("unknown error",{cause:e});r.code==="ERR_STREAM_PREMATURE_CLOSE"?console.info("The user aborted a request."):(console.error(e),t.headersSent||t.writeHead(500,{"Content-Type":"text/plain"}),t.end(`Error: ${r.message}`),t.destroy(r))},Bt=(e,t)=>{var o;const[r,s,n]=e[Re];if(typeof s=="string")n["Content-Length"]=Buffer.byteLength(s),t.writeHead(r,n),t.end(s);else return t.writeHead(r,n),(o=Je(s,t))==null?void 0:o.catch(a=>et(a,t))},Fr=async(e,t,r={})=>{if(e instanceof Promise)if(r.errorHandler)try{e=await e}catch(o){const a=await r.errorHandler(o);if(!a)return;e=a}else e=await e.catch(Ut);if(Re in e)return Bt(e,t);const s=Mt(e.headers),n=$r(e);if(n){const{length:o,source:a,stream:h}=n;if(!(a instanceof Uint8Array&&a.byteLength!==o)){o&&(s["content-length"]=o),t.writeHead(e.status,s),typeof a=="string"||a instanceof Uint8Array?t.end(a):a instanceof Blob?t.end(new Uint8Array(await a.arrayBuffer())):await Je(h,t);return}}if(e.body){const{"transfer-encoding":o,"content-encoding":a,"content-length":h,"x-accel-buffering":c,"content-type":l}=s;if(o||a||h||c&&qr.test(c)||!Ir.test(l))t.writeHead(e.status,s),await Je(e.body,t);else{const f=await e.arrayBuffer();s["content-length"]=f.byteLength,t.writeHead(e.status,s),t.end(new Uint8Array(f))}}else s[Tr]||(t.writeHead(e.status,s),t.end())},kr=(e,t={})=>(t.overrideGlobalObjects!==!1&&global.Request!==we&&(Object.defineProperty(global,"Request",{value:we}),Object.defineProperty(global,"Response",{value:ue})),async(r,s)=>{let n,o;try{if(o=Cr(r,t.hostname),s.on("close",()=>{r.errored?o[Qe]().abort(r.errored.toString()):s.writableFinished||o[Qe]().abort("Client connection prematurely closed.")}),n=e(o,{incoming:r,outgoing:s}),Re in n)return Bt(n,s)}catch(a){if(n)return et(a,s);if(t.errorHandler){if(n=await t.errorHandler(o?a:Sr(a)),!n)return}else o?n=Ut(a):n=Dr()}try{return Fr(n,s,t)}catch(a){return et(a,s)}}),_r=e=>{const t=e.fetch,r=kr(t,{hostname:e.hostname,overrideGlobalObjects:e.overrideGlobalObjects});return(e.createServer||Vt)(e.serverOptions||{},r)},Nr=(e,t)=>{const r=_r(e);return r.listen(e==null?void 0:e.port,e.hostname,()=>{r.address()}),r};const tt=new Nt,Mr=Object.assign({"/src/apps/echo.ts":rt});let Kt=!1;for(const[,e]of Object.entries(Mr))e&&(tt.route("/",e),tt.notFound(t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),console.log(e.notFoundHandler),Kt=!0);if(!Kt)throw new Error("Can't import modules from ['/src/apps/echo.ts']");Nr({fetch:tt.fetch,port:9e3});export{tt as default};
